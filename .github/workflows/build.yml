name: Build Python

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install pyenv and Python 3.9.0
      run: |
        sudo apt-get update
        sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
          libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev \
          libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev

        git clone https://github.com/pyenv/pyenv.git ~/.pyenv
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
        echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
        echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\n  eval "$(pyenv init --path)"\nfi' >> ~/.bashrc
        exec $SHELL

        pyenv install 3.9.0
        pyenv global 3.9.0
        python --version

        # 将相关环境变量添加到 ~/.bashrc
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
        echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
        echo 'if command -v pyenv 1>/dev/null 2>&1; then eval "$(pyenv init --path)"; fi' >> ~/.bashrc

        exec $SHELL

    - name: Run clean.sh and build.sh
      run: |
        chmod +x clean.sh
        ./clean.sh
        ARCH=arm64 ANDROID_API=21 ./build.sh

    - name: Save build artifacts
      run: |
        mkdir build_artifacts
        cp -r build/* build_artifacts/
        echo ::set-output name=build_artifacts_path::build_artifacts

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    
    - name: Checkout repository
      uses: actions/checkout@v2
    
    - name: Deploy to output branch
      run: |
        # Move to the build directory
        cd ${{ needs.build.outputs.build_artifacts_path }}
    
        # Create a new branch if it doesn't exist
        git checkout -B output
    
        # Add and commit the changes
        git add .
        git commit -m "Deploy to output branch"
    
        # Push to the output branch
        git push origin output
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
